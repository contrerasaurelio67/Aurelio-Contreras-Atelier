<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control Atelier</title>
    <meta name="description" content="Panel administrativo para gesti√≥n de publicaciones y sistema.">
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* 
         * =========================================
         * 1. DESIGN SYSTEM & VARIABLES
         * =========================================
         */
        :root {
            --color-bg-light: #F5F5F7;
            --color-surface-light: #FFFFFF;
            --color-text-primary-light: #1D1D1F;
            --color-text-secondary-light: #86868B;
            --color-border-light: #D2D2D7;

            --color-bg-dark: #000000;
            --color-surface-dark: #1C1C1E;
            --color-text-primary-dark: #F5F5F7;
            --color-text-secondary-dark: #86868B;
            --color-border-dark: #38383A;

            --color-accent: #0071E3;
            --color-accent-hover: #0077ED;
            --color-danger: #FF3B30;
            --color-success: #34C759;
            --color-warning: #FF9500;

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 18px;
            --radius-xl: 24px;

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 14px 24px -6px rgba(0, 0, 0, 0.12);

            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --transition-fast: 0.2s cubic-bezier(0.25, 1, 0.5, 1);
            --transition-smooth: 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: var(--color-bg-dark);
                --bg-card: var(--color-surface-dark);
                --text-primary: var(--color-text-primary-dark);
                --text-secondary: var(--color-text-secondary-dark);
                --border-color: var(--color-border-dark);
                --shadow-color: rgba(0, 0, 0, 0.5);
            }
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg-body: var(--color-bg-light);
                --bg-card: var(--color-surface-light);
                --text-primary: var(--color-text-primary-light);
                --text-secondary: var(--color-text-secondary-light);
                --border-color: var(--color-border-light);
                --shadow-color: rgba(0, 0, 0, 0.05);
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-body);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        button,
        input,
        select,
        textarea {
            font-family: inherit;
            border: none;
            outline: none;
        }

        h1,
        h2,
        h3 {
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 2rem;
            align-items: start;
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        /* Header & Status */
        .main-panel header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .header-badges {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .status-badge {
            font-size: 0.85rem;
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-text-secondary);
        }

        .status-dot.online {
            background: var(--color-success);
            box-shadow: 0 0 8px var(--color-success);
        }

        .status-dot.offline {
            background: var(--text-secondary);
        }

        .version-badge {
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.7;
        }

        /* Cards Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            text-align: left;
        }

        .card:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-hover);
            border-color: var(--border-color);
        }

        .card:focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 4px;
        }

        .card.disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(1);
        }

        .card-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            display: block;
        }

        .card-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .card-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .panel-box {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .panel-box h3 {
            font-size: 0.95rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            letter-spacing: 0.05em;
        }

        .preview-content {
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            margin-top: 0.5rem;
            padding: 1rem;
            word-break: break-word;
        }

        .preview-content.has-data {
            display: block;
            text-align: left;
            border: none;
            background: var(--bg-body);
            color: var(--text-primary);
        }

        .history-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .history-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .history-meta {
            display: flex;
            flex-direction: column;
        }

        .history-action {
            font-weight: 500;
        }

        .history-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .history-status {
            font-size: 1.2rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-fast), visibility var(--transition-fast);
            z-index: 1000;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            width: 90%;
            max-width: 480px;
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-hover);
            transform: translateY(20px) scale(0.95);
            transition: transform var(--transition-smooth);
            position: relative;
        }

        .modal-overlay.open .modal {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close-btn {
            background: transparent;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background var(--transition-fast);
        }

        .close-btn:hover {
            background: var(--bg-body);
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            background: var(--bg-body);
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .form-input:focus {
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(0, 113, 227, 0.2);
        }

        .btn-primary {
            width: 100%;
            padding: 1rem;
            background: var(--color-accent);
            color: white;
            font-weight: 600;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary:not(:disabled):hover {
            background: var(--color-accent-hover);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2.5px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .btn-copy {
            margin-top: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: auto;
            min-width: 120px;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .btn-copy:hover {
            background: var(--bg-body);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Toasts */
        #toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 2000;
        }

        .toast {
            background: var(--bg-card);
            border-left: 4px solid var(--color-accent);
            padding: 1rem 1.25rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 300px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease forwards;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .toast.success {
            border-left-color: var(--color-success);
        }

        .toast.error {
            border-left-color: var(--color-danger);
        }

        .toast.warning {
            border-left-color: var(--color-warning);
        }

        .toast.hiding {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(10px);
            }
        }

        /* Stats Panel (Telemetry) */
        .stats-panel {
            margin-top: 1rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- Main Panel -->
        <div class="main-panel">
            <header>
                <div>
                    <h1 style="font-size: 1.8rem;" data-i18n="panelTitle">Panel de Control</h1>
                    <p style="color: var(--text-secondary);" data-i18n="panelSubtitle">Aurelio Contreras Atelier</p>
                </div>
                <div class="header-badges">
                    <div class="status-badge" id="connStatus">
                        <span class="status-dot"></span>
                        <span id="connText" data-i18n="statusChecking">Verificando...</span>
                    </div>
                    <div class="version-badge" id="versionDisplay">v1.0.0</div>
                </div>
            </header>

            <div class="grid" id="actionsGrid">
                <!-- Tarjetas din√°micas -->
            </div>

            <!-- Telemetry Stats (Optional) -->
            <div id="telemetryStats" class="panel-box stats-panel" style="display:none; margin-top:2rem;">
                <h3 data-i18n="statsTitle">M√©tricas de Sesi√≥n</h3>
                <div id="statsContent"></div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="panel-box">
                <h3 data-i18n="previewTitle">Vista Previa</h3>
                <div id="previewArea" class="preview-content" data-i18n="previewPlaceholder">
                    Selecciona una acci√≥n para ver el resultado aqu√≠.
                </div>
            </div>

            <div class="panel-box">
                <h3 data-i18n="historyTitle">√öltimas Acciones</h3>
                <ul class="history-list" id="historyList">
                    <li class="empty-state" data-i18n="historyEmpty">Sin actividad reciente</li>
                </ul>
            </div>
        </aside>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay" aria-modal="true" role="dialog" aria-labelledby="modalTitle">
        <div class="modal" id="modalContent">
            <div class="modal-header">
                <h2 id="modalTitle">Acci√≥n</h2>
                <button class="close-btn" id="modalClose" aria-label="Cerrar modal">&times;</button>
            </div>
            <form id="actionForm" novalidate>
                <div id="modalBody"></div>
                <div style="margin-top: 2rem;">
                    <button type="submit" class="btn-primary" id="modalSubmitBtn">
                        <span class="btn-text" data-i18n="btnExecute">Ejecutar Acci√≥n</span>
                        <div class="spinner" style="display: none;"></div>
                    </button>
                    <div id="formErrors"
                        style="color: var(--color-danger); font-size: 0.85rem; margin-top: 0.5rem; min-height: 1.2em;">
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Toasts -->
    <div id="toast-container"></div>

    <script>
        /**
         * =========================================
         * 0. CONFIGURACI√ìN & FEATURE FLAGS
         * =========================================
         */
        const APP_VERSION = '1.0.0';

        const DEFAULT_ENV = {
            baseURL: 'https://n8n.aureliocontrerasatelier.com',
            webhookPath: '/webhook/panel-action',
            throttleMs: 3000
        };

        const DEFAULT_FLAGS = {
            enableImageAction: true,
            enableTelemetry: true,
            enableMockTester: false // Set to true to test without N8N backend
        };

        // Load Config from LocalStorage
        const CONFIG = {
            ENV: Object.assign(DEFAULT_ENV, JSON.parse(localStorage.getItem('panelEnv') || '{}')),
            FLAGS: Object.assign(DEFAULT_FLAGS, JSON.parse(localStorage.getItem('featureFlags') || '{}')),
            SETTINGS: {
                maxRetries: 3,
                toastDuration: 4000,
                maxHistory: 5,
                closeOnOverlayClick: true
            }
        };

        /**
         * =========================================
         * 1. I18N ENGINE
         * =========================================
         */
        const DICTIONARY = {
            es: {
                panelTitle: 'Panel de Control',
                panelSubtitle: 'Aurelio Contreras Atelier',
                statusChecking: 'Verificando...',
                statusOnline: 'Conectado',
                statusOffline: 'Offline (En cola)',
                statusMock: 'Modo Prueba (Mock)',
                previewTitle: 'Vista Previa',
                previewPlaceholder: 'Selecciona una acci√≥n para ver el resultado aqu√≠.',
                historyTitle: '√öltimas Acciones',
                historyEmpty: 'Sin actividad reciente',
                btnExecute: 'Ejecutar Acci√≥n',
                btnProcessing: 'Procesando...',
                btnCopy: 'Copiar Resultado',
                errRequired: 'Por favor completa los campos requeridos.',
                errServer: 'Error en el servidor',
                errNetwork: 'Error de red. Guardado en cola.',
                msgSuccess: 'Acci√≥n ejecutada correctamente',
                msgCopied: 'Copiado al portapapeles',
                msgRateLimit: 'Demasiadas solicitudes. Espera un momento.',
                msgQueueProcessed: 'Acciones offline procesadas',
                statsTitle: 'M√©tricas de Sesi√≥n'
            },
            en: {
                panelTitle: 'Control Panel',
                panelSubtitle: 'Aurelio Contreras Atelier',
                statusChecking: 'Checking...',
                statusOnline: 'Connected',
                statusOffline: 'Offline (Queued)',
                statusMock: 'Test Mode (Mock)',
                previewTitle: 'Preview',
                previewPlaceholder: 'Select an action to view results here.',
                historyTitle: 'Recent Actions',
                historyEmpty: 'No recent activity',
                btnExecute: 'Execute Action',
                btnProcessing: 'Processing...',
                btnCopy: 'Copy Result',
                errRequired: 'Please complete required fields.',
                errServer: 'Server Error',
                errNetwork: 'Network error. Queued.',
                msgSuccess: 'Action executed successfully',
                msgCopied: 'Copied to clipboard',
                msgRateLimit: 'Too many requests. Please wait.',
                msgQueueProcessed: 'Offline actions processed',
                statsTitle: 'Session Metrics'
            }
        };

        const I18n = {
            lang: navigator.language.startsWith('es') ? 'es' : 'en',
            t: (key) => DICTIONARY[I18n.lang][key] || key,
            updateUI: () => {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    el.textContent = I18n.t(key);
                });
            }
        };

        /**
         * =========================================
         * 2. TELEMETRY & AUDIT
         * =========================================
         */
        const Telemetry = {
            metrics: { success: 0, error: 0, actions: {} },

            log: (type, actionKey) => {
                if (!CONFIG.FLAGS.enableTelemetry) return;

                // Update counters
                if (type === 'SUCCESS') Telemetry.metrics.success++;
                if (type === 'ERROR') Telemetry.metrics.error++;
                Telemetry.metrics.actions[actionKey] = (Telemetry.metrics.actions[actionKey] || 0) + 1;

                // Update UI if visible
                Telemetry.renderStats();
            },

            audit: (event, data) => {
                // Console Audit
                console.groupCollapsed(`[AUDIT] ${event} @ ${new Date().toLocaleTimeString()}`);
                console.log('UserAgent:', navigator.userAgent);
                console.log('Language:', I18n.lang);
                console.log('Payload/Data:', data);
                console.groupEnd();
            },

            renderStats: () => {
                const el = document.getElementById('statsContent');
                if (!el) return;
                el.innerHTML = `
                    <div class="stat-row"><span>Success:</span> <span style="color:var(--color-success)">${Telemetry.metrics.success}</span></div>
                    <div class="stat-row"><span>Errors:</span> <span style="color:var(--color-danger)">${Telemetry.metrics.error}</span></div>
                    <div style="margin-top:0.5rem; border-top:1px solid var(--border-color); padding-top:0.5rem">
                        ${Object.entries(Telemetry.metrics.actions).map(([k, v]) => `<div class="stat-row"><span>${k}:</span> <span>${v}</span></div>`).join('')}
                    </div>
                `;
            }
        };

        /**
         * =========================================
         * 3. ACTIONS DEFINITION
         * =========================================
         */
        const ACTIONS_CONFIG = {
            'generate_posts': {
                title: { es: 'Generar Publicaciones', en: 'Generate Posts' },
                desc: { es: 'Crear nuevos posts con IA base', en: 'Create new posts with AI' },
                icon: '‚ú®',
                fields: [
                    { id: 'theme', label: { es: 'Tema Principal', en: 'Main Theme' }, type: 'text', placeholder: 'Minimalismo...', required: true },
                    { id: 'tone', label: { es: 'Tono', en: 'Tone' }, type: 'select', options: ['Elegante', 'Casual', 'Informativo'], required: true }
                ],
                preview: (data) => `<strong>Posts:</strong><br>${data.titles ? data.titles.join('<br>') : 'OK'}`
            },
            'schedule_post': {
                title: { es: 'Programar Publicaci√≥n', en: 'Schedule Post' },
                desc: { es: 'Agendar contenido para el futuro', en: 'Schedule content for future' },
                icon: 'üìÖ',
                fields: [
                    { id: 'date', label: { es: 'Fecha', en: 'Date' }, type: 'date', required: true },
                    { id: 'time', label: { es: 'Hora', en: 'Time' }, type: 'time', required: true },
                    { id: 'content_id', label: 'ID (Ops)', type: 'text', placeholder: 'Auto' }
                ],
                preview: (data) => `‚úÖ <strong>Scheduled</strong><br>${data.scheduledDate || 'TBD'}`
            },
            'system_diag': {
                title: { es: 'Diagn√≥stico del Sistema', en: 'System Diagnosis' },
                desc: { es: 'Verificar salud de servicios', en: 'Check service health' },
                icon: 'ü©∫',
                fields: [],
                preview: (data) => `<strong>System Status:</strong><br>${data.healthy ? 'üü¢ Healthy' : 'üî¥ Issues'}`
            },
            'upload_media': {
                title: { es: 'Subir Media', en: 'Upload Media' },
                desc: { es: 'Cargar imagen para post', en: 'Upload image for post' },
                icon: 'üì∑',
                flag: 'enableImageAction', // Feature Flag
                fields: [
                    { id: 'file', label: { es: 'Imagen (Max 2MB)', en: 'Image (Max 2MB)' }, type: 'file', accept: 'image/*', required: true },
                    { id: 'caption', label: { es: 'Descripci√≥n', en: 'Caption' }, type: 'text' }
                ],
                preview: (data) => `üì∏ <strong>Uploaded</strong><br>URL: ${data.fileUrl || 'Generated'}`
            }
        };

        /**
         * =========================================
         * 4. STATE & UTILS
         * =========================================
         */
        const State = {
            history: JSON.parse(localStorage.getItem('panelHistory') || '[]'),
            queue: JSON.parse(localStorage.getItem('panelQueue') || '[]'),
            lastActionTime: 0,
            currentAction: null
        };

        const Utils = {
            uuid: () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            }),
            formatDate: (ts) => new Date(ts).toLocaleString(I18n.lang, {
                month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            })
        };

        /**
         * =========================================
         * 5. NETWORK ENGINE (MOCK + RETRY)
         * =========================================
         */
        const Network = {
            send: async (payload) => {
                // Mock Mode Check
                if (CONFIG.FLAGS.enableMockTester) {
                    await new Promise(r => setTimeout(r, 1000)); // Simulate latency
                    return Network.getMockResponse(payload);
                }

                // Real Network Call
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);

                try {
                    const token = localStorage.getItem('panelToken');
                    const headers = {
                        'Content-Type': 'application/json',
                        'X-Request-ID': payload.requestId,
                        'X-Client-Version': APP_VERSION
                    };
                    if (token) headers['Authorization'] = `Bearer ${token}`;

                    const res = await fetch(CONFIG.ENV.baseURL + CONFIG.ENV.webhookPath, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(payload),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json();
                } catch (err) {
                    clearTimeout(timeoutId);
                    throw err;
                }
            },

            getMockResponse: (payload) => {
                return {
                    success: true,
                    mock: true,
                    data: {
                        titles: ['Post Demo 1', 'Post Demo 2'],
                        scheduledDate: '2025-12-15 10:00',
                        healthy: true,
                        fileUrl: 'https://via.placeholder.com/150'
                    }
                };
            },

            processQueue: async () => {
                if (State.queue.length === 0 || !navigator.onLine) return;

                const queueCopy = [...State.queue];
                State.queue = [];
                localStorage.setItem('panelQueue', '[]');

                let processed = 0;
                for (const item of queueCopy) {
                    try {
                        await Network.send(item);
                        App.addToHistory(item.action, true);
                        processed++;
                    } catch (e) {
                        // Re-queue if failed
                        State.queue.push(item);
                    }
                }
                localStorage.setItem('panelQueue', JSON.stringify(State.queue));
                if (processed > 0) Toast.show(I18n.t('msgQueueProcessed'), 'success');
                UI.renderHistory();
            }
        };

        /**
         * =========================================
         * 6. UI MANAGER
         * =========================================
         */
        const UI = {
            renderGrid: () => {
                const container = document.getElementById('actionsGrid');
                container.innerHTML = Object.entries(ACTIONS_CONFIG).map(([key, action]) => {
                    // Feature Flag Check
                    if (action.flag && !CONFIG.FLAGS[action.flag]) return '';

                    const title = action.title[I18n.lang] || action.title.es;
                    const desc = action.desc[I18n.lang] || action.desc.es;

                    return `
                    <div class="card" role="button" tabindex="0" onclick="App.openModal('${key}')">
                        <span class="card-icon" aria-hidden="true">${action.icon}</span>
                        <div class="card-title">${title}</div>
                        <div class="card-desc">${desc}</div>
                    </div>`;
                }).join('');
            },

            renderHistory: () => {
                const container = document.getElementById('historyList');
                if (State.history.length === 0) {
                    container.innerHTML = `<li class="empty-state">${I18n.t('historyEmpty')}</li>`;
                    return;
                }
                container.innerHTML = State.history.map(item => `
                    <li class="history-item">
                        <div class="history-meta">
                            <span class="history-action">${(ACTIONS_CONFIG[item.action]?.title[I18n.lang] || item.action)}</span>
                            <span class="history-time">${Utils.formatDate(item.ts)}</span>
                        </div>
                        <span class="history-status" title="${item.success ? 'Success' : 'Error'}">
                            ${item.success ? '‚úÖ' : '‚ùå'}
                        </span>
                    </li>
                `).join('');
            },

            updateConnStatus: () => {
                const dot = document.querySelector('.status-dot');
                const text = document.getElementById('connText');

                if (CONFIG.FLAGS.enableMockTester) {
                    dot.className = 'status-dot warning';
                    dot.style.background = 'var(--color-warning)';
                    text.textContent = I18n.t('statusMock');
                    return;
                }

                if (navigator.onLine) {
                    dot.className = 'status-dot online';
                    text.textContent = I18n.t('statusOnline');
                } else {
                    dot.className = 'status-dot offline';
                    text.textContent = I18n.t('statusOffline');
                }
            },

            setLoading: (isLoading) => {
                const btn = document.getElementById('modalSubmitBtn');
                const spinner = btn.querySelector('.spinner');
                const text = btn.querySelector('.btn-text');
                btn.disabled = isLoading;
                spinner.style.display = isLoading ? 'block' : 'none';
                text.textContent = isLoading ? I18n.t('btnProcessing') : I18n.t('btnExecute');
            }
        };

        const Toast = {
            show: (msg, type = 'info') => {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = `toast ${type}`;
                el.textContent = msg;
                container.appendChild(el);
                setTimeout(() => {
                    el.classList.add('hiding');
                    el.addEventListener('animationend', () => el.remove());
                }, CONFIG.SETTINGS.toastDuration);
            }
        };

        /**
         * =========================================
         * 7. MAIN APP CONTROLLER
         * =========================================
         */
        const App = {
            init: () => {
                // Initialize I18n
                I18n.updateUI();
                document.getElementById('versionDisplay').textContent = `v${APP_VERSION}`;

                if (CONFIG.FLAGS.enableTelemetry) {
                    document.getElementById('telemetryStats').style.display = 'block';
                    Telemetry.renderStats();
                }

                UI.renderGrid();
                UI.renderHistory();
                UI.updateConnStatus();

                // Listeners
                window.addEventListener('online', () => { UI.updateConnStatus(); Network.processQueue(); });
                window.addEventListener('offline', () => { UI.updateConnStatus(); });

                document.getElementById('modalClose').onclick = App.closeModal;
                document.getElementById('modalOverlay').onclick = (e) => {
                    if (CONFIG.SETTINGS.closeOnOverlayClick && e.target.id === 'modalOverlay') App.closeModal();
                };

                document.getElementById('actionForm').onsubmit = App.handleSubmit;
            },

            openModal: (actionKey) => {
                // Rate Limiting Check
                const now = Date.now();
                if (now - State.lastActionTime < CONFIG.ENV.throttleMs) {
                    Toast.show(I18n.t('msgRateLimit'), 'warning');
                    return;
                }

                State.currentAction = actionKey;
                const config = ACTIONS_CONFIG[actionKey];

                document.getElementById('modalTitle').textContent = config.title[I18n.lang];
                const body = document.getElementById('modalBody');

                // Build Fields
                if (config.fields.length === 0) {
                    body.innerHTML = `<p style="text-align:center;color:var(--text-secondary)">${config.desc[I18n.lang]}</p>`;
                } else {
                    body.innerHTML = config.fields.map(field => {
                        const label = typeof field.label === 'object' ? field.label[I18n.lang] : field.label;
                        let inputHtml = '';

                        if (field.type === 'select') {
                            inputHtml = `<select id="f_${field.id}" class="form-input" ${field.required ? 'required' : ''}>
                                ${field.options.map(o => `<option value="${o}">${o}</option>`).join('')}
                            </select>`;
                        } else {
                            inputHtml = `<input type="${field.type}" id="f_${field.id}" class="form-input" 
                                placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''} 
                                ${field.accept ? `accept="${field.accept}"` : ''}>`;
                        }
                        return `<div class="form-group"><label class="form-label">${label}</label>${inputHtml}</div>`;
                    }).join('');
                }

                document.getElementById('modalOverlay').classList.add('open');
                document.body.style.overflow = 'hidden';
            },

            closeModal: () => {
                document.getElementById('modalOverlay').classList.remove('open');
                document.body.style.overflow = '';
                document.getElementById('actionForm').reset();
                State.currentAction = null;
            },

            handleSubmit: async (e) => {
                e.preventDefault();
                State.lastActionTime = Date.now();

                const actionKey = State.currentAction;
                const config = ACTIONS_CONFIG[actionKey];
                const errorDiv = document.getElementById('formErrors');
                errorDiv.textContent = '';

                // Validation & Data Collection
                const formData = {};
                let isValid = true;
                for (const field of config.fields) {
                    const el = document.getElementById(`f_${field.id}`);
                    if (field.required && !el.value) isValid = false;

                    if (field.type === 'file' && el.files.length > 0) {
                        formData[field.id] = { name: el.files[0].name, size: el.files[0].size }; // Metadata only for demo
                    } else {
                        formData[field.id] = el.value;
                    }
                }

                if (!isValid) {
                    errorDiv.textContent = I18n.t('errRequired');
                    return;
                }

                UI.setLoading(true);

                const payload = {
                    action: actionKey,
                    requestId: Utils.uuid(),
                    data: formData,
                    client: { ts: Date.now(), userAgent: navigator.userAgent }
                };

                // Telemetry Audit
                Telemetry.audit('SUBMIT', payload);

                // Offline Handling
                if (!navigator.onLine && !CONFIG.FLAGS.enableMockTester) {
                    State.queue.push(payload);
                    localStorage.setItem('panelQueue', JSON.stringify(State.queue));
                    setTimeout(() => {
                        UI.setLoading(false);
                        App.closeModal();
                        Toast.show(I18n.t('errNetwork'), 'warning');
                        App.addToHistory(actionKey, null);
                    }, 500);
                    return;
                }

                try {
                    const response = await Network.send(payload);

                    Telemetry.log('SUCCESS', actionKey);
                    Toast.show(I18n.t('msgSuccess'), 'success');

                    // Update Preview
                    if (config.preview) {
                        const previewHtml = config.preview(response.data || response);
                        document.getElementById('previewArea').innerHTML = previewHtml;
                        document.getElementById('previewArea').classList.add('has-data');

                        // Add Copy Button
                        const btn = document.createElement('button');
                        btn.className = 'btn-primary btn-copy';
                        btn.textContent = I18n.t('btnCopy');
                        btn.onclick = () => {
                            navigator.clipboard.writeText(document.getElementById('previewArea').innerText);
                            Toast.show(I18n.t('msgCopied'), 'info');
                        };
                        document.getElementById('previewArea').appendChild(document.createElement('br'));
                        document.getElementById('previewArea').appendChild(btn);
                    }

                    App.addToHistory(actionKey, true);
                    App.closeModal();
                } catch (err) {
                    console.error(err);
                    Telemetry.log('ERROR', actionKey);
                    errorDiv.textContent = I18n.t('errServer');
                    Toast.show(I18n.t('errServer'), 'error');
                } finally {
                    UI.setLoading(false);
                }
            },

            addToHistory: (actionKey, success) => {
                const item = { action: actionKey, ts: Date.now(), success };
                State.history.unshift(item);
                if (State.history.length > CONFIG.SETTINGS.maxHistory) State.history.pop();
                localStorage.setItem('panelHistory', JSON.stringify(State.history));
                UI.renderHistory();
            }
        };

        // Boot
        document.addEventListener('DOMContentLoaded', App.init);

    </script>
</body>

</html>
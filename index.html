<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control Atelier</title>
    <meta name="description" content="Panel administrativo para gesti√≥n de publicaciones y sistema.">
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* 
         * =========================================
         * 1. DESIGN SYSTEM & VARIABLES
         * =========================================
         */
        :root {
            --color-bg-light: #F5F5F7;
            --color-surface-light: #FFFFFF;
            --color-text-primary-light: #1D1D1F;
            --color-text-secondary-light: #86868B;
            --color-border-light: #D2D2D7;

            --color-bg-dark: #000000;
            --color-surface-dark: #1C1C1E;
            --color-text-primary-dark: #F5F5F7;
            --color-text-secondary-dark: #86868B;
            --color-border-dark: #38383A;

            --color-accent: #0071E3;
            --color-accent-hover: #0077ED;
            --color-danger: #FF3B30;
            --color-success: #34C759;
            --color-warning: #FF9500;

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 18px;
            --radius-xl: 24px;

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 14px 24px -6px rgba(0, 0, 0, 0.12);

            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --transition-fast: 0.2s cubic-bezier(0.25, 1, 0.5, 1);
            --transition-smooth: 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: var(--color-bg-dark);
                --bg-card: var(--color-surface-dark);
                --text-primary: var(--color-text-primary-dark);
                --text-secondary: var(--color-text-secondary-dark);
                --border-color: var(--color-border-dark);
                --shadow-color: rgba(0, 0, 0, 0.5);
            }
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg-body: var(--color-bg-light);
                --bg-card: var(--color-surface-light);
                --text-primary: var(--color-text-primary-light);
                --text-secondary: var(--color-text-secondary-light);
                --border-color: var(--color-border-light);
                --shadow-color: rgba(0, 0, 0, 0.05);
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-body);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            position: relative;
        }

        button,
        input,
        select,
        textarea {
            font-family: inherit;
            border: none;
            outline: none;
        }

        h1,
        h2,
        h3 {
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        /* LOGIN SCREEN */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-body);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        .login-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-card {
            background: var(--bg-card);
            padding: 2.5rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-hover);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-logo {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* MAIN APP */
        .app-container {
            width: 100%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 2rem;
            align-items: start;
            opacity: 0;
            transition: opacity 0.5s ease 0.2s;
        }

        .app-container.visible {
            opacity: 1;
        }

        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
            }
        }

        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .header-badges {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .status-badge {
            font-size: 0.85rem;
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-text-secondary);
        }

        .status-dot.online {
            background: var(--color-success);
            box-shadow: 0 0 8px var(--color-success);
        }

        .status-dot.offline {
            background: var(--text-secondary);
        }

        .status-dot.warning {
            background: var(--color-warning);
        }

        .btn-logout {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--color-danger);
            transition: background 0.2s;
        }

        .btn-logout:hover {
            background: var(--bg-body);
        }

        /* SECTIONS & GRID */
        .section-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin: 2rem 0 1rem 0;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            text-align: left;
        }

        .card:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-hover);
            border-color: var(--border-color);
        }

        .card:focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 4px;
        }

        .card-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            display: block;
        }

        .card-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .card-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* SIDEBAR */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .panel-box {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .panel-box h3 {
            font-size: 0.95rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            letter-spacing: 0.05em;
        }

        .preview-content {
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            margin-top: 0.5rem;
            padding: 1rem;
            word-break: break-word;
        }

        .preview-content.has-data {
            display: block;
            text-align: left;
            border: none;
            background: var(--bg-body);
            color: var(--text-primary);
        }

        .history-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .history-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .history-meta {
            display: flex;
            flex-direction: column;
        }

        .history-action {
            font-weight: 500;
        }

        .history-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-fast), visibility var(--transition-fast);
            z-index: 1000;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            width: 90%;
            max-width: 480px;
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-hover);
            transform: translateY(20px) scale(0.95);
            transition: transform var(--transition-smooth);
            position: relative;
        }

        .modal-overlay.open .modal {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close-btn {
            background: transparent;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: var(--bg-body);
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            background: var(--bg-body);
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .form-input:focus {
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(0, 113, 227, 0.2);
        }

        .btn-primary {
            width: 100%;
            padding: 1rem;
            background: var(--color-accent);
            color: white;
            font-weight: 600;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background: var(--color-accent-hover);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2.5px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* TOASTS */
        #toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 2000;
        }

        .toast {
            background: var(--bg-card);
            border-left: 4px solid var(--color-accent);
            padding: 1rem 1.25rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 300px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease forwards;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .toast.success {
            border-left-color: var(--color-success);
        }

        .toast.error {
            border-left-color: var(--color-danger);
        }

        .toast.warning {
            border-left-color: var(--color-warning);
        }

        .toast.hiding {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(10px);
            }
        }
    </style>
</head>

<body>

    <!-- PANTALLA DE ACCESO -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-logo">üîí</div>
            <h2 style="margin-bottom: 0.5rem;">Atelier Access</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">Ingresa tus credenciales</p>
            <form id="loginForm">
                <div class="form-group">
                    <input type="text" id="username" class="form-input" placeholder="Usuario" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password" class="form-input" placeholder="Contrase√±a" required>
                </div>
                <button type="submit" class="btn-primary">Ingresar</button>
            </form>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="appContainer" class="app-container">
        <!-- Main Panel -->
        <div class="main-panel">
            <header>
                <div>
                    <h1 style="font-size: 1.8rem;" data-i18n="panelTitle">Panel de Control</h1>
                    <p style="color: var(--text-secondary);" data-i18n="panelSubtitle">Aurelio Contreras Atelier</p>
                </div>
                <div class="header-badges">
                    <div class="status-badge" id="connStatus">
                        <span class="status-dot"></span>
                        <span id="connText">Verificando...</span>
                    </div>
                    <button class="btn-logout" id="logoutBtn" title="Cerrar Sesi√≥n">‚èª</button>
                </div>
            </header>

            <div id="actionsContainer">
                <!-- ACCIONES AGRUPADAS SE RENDERIZAN AQUI -->
            </div>

            <!-- Telemetry Stats -->
            <div id="telemetryStats" class="panel-box"
                style="display:none; margin-top:2rem; font-size:0.8rem; color:var(--text-secondary);">
                <h3 data-i18n="statsTitle">M√©tricas</h3>
                <div id="statsContent"></div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="panel-box">
                <h3 data-i18n="previewTitle">Vista Previa</h3>
                <div id="previewArea" class="preview-content" data-i18n="previewPlaceholder">...</div>
            </div>

            <div class="panel-box">
                <h3 data-i18n="historyTitle">√öltimas Acciones</h3>
                <ul class="history-list" id="historyList"></ul>
            </div>
        </aside>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Acci√≥n</h2>
                <button class="close-btn" id="modalClose">&times;</button>
            </div>
            <form id="actionForm" novalidate>
                <div id="modalBody"></div>
                <div style="margin-top: 2rem;">
                    <button type="submit" class="btn-primary" id="modalSubmitBtn">
                        <span class="btn-text" data-i18n="btnExecute">Ejecutar</span>
                        <div class="spinner" style="display: none;"></div>
                    </button>
                    <div id="formErrors"
                        style="color: var(--color-danger); font-size: 0.85rem; margin-top: 0.5rem; min-height: 1.2em;">
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Toasts -->
    <div id="toast-container"></div>

    <script>
        /** ----- CONFIG & CONSTANTS ----- */
        const APP_VERSION = '1.1.0';
        const CREDS = { u: 'econtreras', p: 'Ec1330' }; // En producci√≥n usar JWT/Backend

        const DEFAULT_FLAGS = { enableMockTester: false, enableTelemetry: true };
        const CONFIG = {
            ENV: { baseURL: 'https://n8n.aureliocontrerasatelier.com/webhook/panel-action', throttleMs: 3000 },
            FLAGS: Object.assign(DEFAULT_FLAGS, JSON.parse(localStorage.getItem('featureFlags') || '{}'))
        };

        /** ----- I18N ----- */
        const DICTIONARY = {
            es: {
                panelTitle: 'Panel de Control', panelSubtitle: 'Aurelio Contreras Atelier',
                statusOnline: 'En L√≠nea', statusOffline: 'Offline', statusMock: 'Modo Test',
                previewTitle: 'Vista Previa', previewPlaceholder: 'Selecciona una acci√≥n...',
                historyTitle: 'Historial', historyEmpty: 'Sin actividad',
                btnExecute: 'Ejecutar', btnProcessing: 'Procesando...',
                catContent: 'Gesti√≥n de Contenido', catSystem: 'Sistema y Operaciones', catAudit: 'Auditor√≠a y Control'
            },
            en: {
                panelTitle: 'Control Panel', panelSubtitle: 'Aurelio Contreras Atelier',
                statusOnline: 'Online', statusOffline: 'Offline', statusMock: 'Test Mode',
                previewTitle: 'Preview', previewPlaceholder: 'Select action...',
                historyTitle: 'History', historyEmpty: 'No activity',
                btnExecute: 'Execute', btnProcessing: 'Processing...',
                catContent: 'Content Management', catSystem: 'System & Ops', catAudit: 'Audit & Control'
            }
        };
        const I18n = {
            lang: navigator.language.startsWith('es') ? 'es' : 'en',
            t: (k) => DICTIONARY[I18n.lang][k] || k,
            update: () => document.querySelectorAll('[data-i18n]').forEach(el => el.textContent = I18n.t(el.dataset.i18n))
        };

        /** ----- ACTIONS SCHEMA (EXTENDED) ----- */
        const ACTIONS = {
            // CATEGORIA: GESTION DE CONTENIDO
            'generate_posts': {
                cat: 'catContent', title: { es: 'Generar Posts', en: 'Generate Posts' },
                desc: { es: 'Crear contenido con IA', en: 'AI Content Generation' },
                icon: '‚ú®',
                fields: [
                    { id: 'topic', label: 'Tema', type: 'text', required: true },
                    { id: 'style', label: 'Estilo', type: 'select', options: ['Minimal', 'Lujo', 'Story'], required: true }
                ]
            },
            'schedule_post': {
                cat: 'catContent', title: { es: 'Programar', en: 'Schedule' },
                desc: { es: 'Agendar publicaci√≥n', en: 'Schedule Post' },
                icon: 'üìÖ',
                fields: [
                    { id: 'date', label: 'Fecha', type: 'date', required: true },
                    { id: 'time', label: 'Hora', type: 'time', required: true }
                ]
            },
            'pin_post': {
                cat: 'catContent', title: { es: 'Fijar Post', en: 'Pin Post' },
                desc: { es: 'Destacar publicaci√≥n', en: 'Pin to top' },
                icon: 'üìå',
                fields: [
                    { id: 'postId', label: 'ID Publicaci√≥n', type: 'text', required: true },
                    { id: 'duration', label: 'Duraci√≥n (d√≠as)', type: 'number', placeholder: '7' }
                ]
            },
            'upload_media': {
                cat: 'catContent', title: { es: 'Subir Media', en: 'Upload Media' },
                desc: { es: 'Cargar recursos', en: 'Upload assets' },
                icon: 'üì∑',
                fields: [
                    { id: 'file', label: 'Archivo', type: 'file', accept: 'image/*', required: true }
                ]
            },

            // CATEGORIA: SISTEMA
            'list_panels': {
                cat: 'catSystem', title: { es: 'Listar Paneles', en: 'List Panels' },
                desc: { es: 'Ver paneles activos', en: 'Active panels' },
                icon: 'üéõÔ∏è',
                fields: [], // Sin parametros
                preview: (d) => `<strong>Paneles:</strong><br>${d.panels ? d.panels.join(', ') : 'Lista vac√≠a'}`
            },
            'system_diag': {
                cat: 'catSystem', title: { es: 'Diagn√≥stico', en: 'Diagnostics' },
                desc: { es: 'Salud del sistema', en: 'System Health' },
                icon: 'ü©∫',
                fields: []
            },

            // CATEGORIA: AUDITORIA
            'view_logs': {
                cat: 'catAudit', title: { es: 'Ver Logs', en: 'View Logs' },
                desc: { es: 'Auditor√≠a reciente', en: 'Recent logs' },
                icon: 'üìú',
                fields: [
                    { id: 'limit', label: 'L√≠mite', type: 'number', placeholder: '50' },
                    { id: 'level', label: 'Nivel', type: 'select', options: ['INFO', 'WARN', 'ERROR'] }
                ],
                preview: (d) => `<div style="max-height:150px;overflow:auto;font-family:monospace;font-size:0.8em">${d.logs || 'Sin logs'}</div>`
            }
        };

        /** ----- STATE & UTILS ----- */
        const State = {
            history: JSON.parse(localStorage.getItem('panelHistory') || '[]'),
            queue: JSON.parse(localStorage.getItem('panelQueue') || '[]'),
            lastAction: 0,
            token: localStorage.getItem('panelToken')
        };

        const Utils = {
            uuid: () => crypto.randomUUID(),
            date: (ts) => new Date(ts).toLocaleString(I18n.lang),
            delay: (ms) => new Promise(r => setTimeout(r, ms))
        };

        /** ----- APP LOGIC ----- */
        const App = {
            init: () => {
                I18n.update();

                // Auth Check
                if (!State.token) {
                    document.getElementById('loginScreen').classList.remove('hidden');
                } else {
                    App.showMain();
                }

                // Render Actions
                App.renderActions();
                App.renderHistory();

                // Listeners
                document.getElementById('loginForm').onsubmit = App.handleLogin;
                document.getElementById('logoutBtn').onclick = App.logout;
                document.getElementById('modalClose').onclick = App.closeModal;
                document.getElementById('modalOverlay').onclick = (e) => { if (e.target.id === 'modalOverlay') App.closeModal(); };
                document.getElementById('actionForm').onsubmit = App.handleAction;

                window.addEventListener('online', () => Toast.show(I18n.t('statusOnline'), 'success'));
                window.addEventListener('offline', () => Toast.show(I18n.t('statusOffline'), 'warning'));
            },

            showMain: () => {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.add('visible');
                UI.updateStatus();
            },

            handleLogin: (e) => {
                e.preventDefault();
                const u = document.getElementById('username').value;
                const p = document.getElementById('password').value;

                if (u === CREDS.u && p === CREDS.p) {
                    State.token = 'mock-token-' + Date.now();
                    localStorage.setItem('panelToken', State.token);
                    App.showMain();
                } else {
                    Toast.show('Credenciales inv√°lidas', 'error');
                }
            },

            logout: () => {
                localStorage.removeItem('panelToken');
                location.reload();
            },

            renderActions: () => {
                const container = document.getElementById('actionsContainer');
                const grouped = {};

                // Group by Category
                for (const [key, conf] of Object.entries(ACTIONS)) {
                    const cat = conf.cat || 'catSystem';
                    if (!grouped[cat]) grouped[cat] = [];
                    grouped[cat].push({ key, ...conf });
                }

                // Generate HTML
                container.innerHTML = Object.entries(grouped).map(([catKey, items]) => `
                    <h3 class="section-title">${I18n.t(catKey)}</h3>
                    <div class="grid">
                        ${items.map(item => `
                            <div class="card" onclick="App.openModal('${item.key}')" role="button" tabindex="0">
                                <span class="card-icon">${item.icon}</span>
                                <div class="card-title">${item.title[I18n.lang] || item.title.es}</div>
                                <div class="card-desc">${item.desc[I18n.lang] || item.desc.es}</div>
                            </div>
                        `).join('')}
                    </div>
                `).join('');
            },

            renderHistory: () => {
                const el = document.getElementById('historyList');
                if (!State.history.length) return el.innerHTML = `<li class="empty-state">${I18n.t('historyEmpty')}</li>`;

                el.innerHTML = State.history.map(h => `
                    <li class="history-item">
                        <div class="history-meta">
                            <span class="history-action">${(ACTIONS[h.action]?.title[I18n.lang] || h.action)}</span>
                            <span class="history-time">${Utils.date(h.ts)}</span>
                        </div>
                        <span>${h.success ? '‚úÖ' : '‚ùå'}</span>
                    </li>
                `).join('');
            },

            openModal: (key) => {
                if (Date.now() - State.lastAction < CONFIG.ENV.throttleMs) return Toast.show('Espera un momento...', 'warning');

                State.currentKey = key;
                const action = ACTIONS[key];
                document.getElementById('modalTitle').textContent = action.title[I18n.lang] || action.title.es;

                const body = document.getElementById('modalBody');
                if (action.fields.length === 0) {
                    body.innerHTML = '<p style="text-align:center;color:var(--text-secondary)">¬øConfirmar acci√≥n?</p>';
                } else {
                    body.innerHTML = action.fields.map(f => `
                        <div class="form-group">
                            <label class="form-label">${f.label}</label>
                            ${f.type === 'select'
                            ? `<select id="f_${f.id}" class="form-input">${f.options.map(o => `<option>${o}</option>`)}</select>`
                            : `<input type="${f.type}" id="f_${f.id}" class="form-input" ${f.required ? 'required' : ''} ${f.placeholder ? `placeholder="${f.placeholder}"` : ''}>`
                        }
                        </div>
                    `).join('');
                }

                document.getElementById('modalOverlay').classList.add('open');
            },

            closeModal: () => {
                document.getElementById('modalOverlay').classList.remove('open');
                document.getElementById('actionForm').reset();
            },

            handleAction: async (e) => {
                e.preventDefault();
                State.lastAction = Date.now();

                const key = State.currentKey;
                const action = ACTIONS[key];
                const data = {};

                // Collect Data
                for (const f of action.fields) {
                    const el = document.getElementById(`f_${f.id}`);
                    if (f.type === 'file' && el.files[0]) data[f.id] = { name: el.files[0].name };
                    else data[f.id] = el.value;
                }

                UI.setLoading(true);

                const payload = {
                    action: key,
                    data,
                    requestId: Utils.uuid(),
                    ts: Date.now()
                };

                // Network Logic (Mock or Real)
                try {
                    let response;
                    if (CONFIG.FLAGS.enableMockTester || !navigator.onLine) {
                        await Utils.delay(1000);
                        response = { success: true, data: { msg: 'Simulated OK' } };
                        if (!navigator.onLine) Toast.show('Guardado en cola (Offline)', 'warning');
                    } else {
                        const res = await fetch(CONFIG.ENV.baseURL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${State.token}` },
                            body: JSON.stringify(payload)
                        });
                        if (!res.ok) throw new Error('API Error');
                        response = await res.json();
                    }

                    Toast.show(I18n.t('btnExecute') + ' OK', 'success');

                    // Preview
                    const previewHtml = action.preview ? action.preview(response.data || response) : JSON.stringify(response.data || response);
                    document.getElementById('previewArea').innerHTML = previewHtml;
                    document.getElementById('previewArea').classList.add('has-data');

                    State.history.unshift({ action: key, ts: Date.now(), success: true });
                    localStorage.setItem('panelHistory', JSON.stringify(State.history));
                    App.renderHistory();
                    App.closeModal();

                } catch (err) {
                    console.error(err);
                    Toast.show('Error al ejecutar', 'error');
                } finally {
                    UI.setLoading(false);
                }
            }
        };

        const UI = {
            setLoading: (l) => {
                const btn = document.getElementById('modalSubmitBtn');
                btn.disabled = l;
                btn.querySelector('.spinner').style.display = l ? 'block' : 'none';
            },
            updateStatus: () => {
                const dot = document.querySelector('.status-dot');
                if (CONFIG.FLAGS.enableMockTester) {
                    dot.className = 'status-dot warning';
                    document.getElementById('connText').textContent = I18n.t('statusMock');
                } else {
                    dot.className = navigator.onLine ? 'status-dot online' : 'status-dot offline';
                    document.getElementById('connText').textContent = navigator.onLine ? I18n.t('statusOnline') : I18n.t('statusOffline');
                }
            }
        };

        const Toast = {
            show: (msg, type) => {
                const t = document.createElement('div');
                t.className = `toast ${type}`;
                t.textContent = msg;
                document.getElementById('toast-container').appendChild(t);
                setTimeout(() => t.remove(), 4000);
            }
        };

        // Init
        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>

</html>